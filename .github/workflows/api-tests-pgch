  api-tests-pgch:
    name: API tests (Postgres + ClickHouse)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: pbi_db
          POSTGRES_USER: pbi_user
          POSTGRES_PASSWORD: pbi_pass
        ports: [ "5432:5432" ]
        options: >-
          --health-cmd="pg_isready -U pbi_user -d pbi_db"
          --health-interval=10s --health-timeout=5s --health-retries=5
      clickhouse:
        image: clickhouse/clickhouse-server:24.3
        ports: [ "9000:9000", "8123:8123" ]

    steps:
      - uses: actions/checkout@v4

      - name: Detect pgch tests
        id: detect_pgch
        run: |
          if [ -d app/tests ] && ls app/tests | grep -E '^test_api_pgch.*\.py$' >/dev/null 2>&1; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-python@v5
        if: steps.detect_pgch.outputs.has_tests == 'true'
        with:
          python-version: "3.11"

      - name: Install pytest + deps
        if: steps.detect_pgch.outputs.has_tests == 'true'
        run: |
          python -m pip install -U pip pytest || true
          if [ -f requirements.txt ]; then pip install -r requirements.txt || true; fi
          if [ -f app/backend/requirements.txt ]; then pip install -r app/backend/requirements.txt || true; fi

      - name: Prepare output dir
        if: steps.detect_pgch.outputs.has_tests == 'true'
        run: mkdir -p tests_output

      - name: Run PG/CH tests
        if: steps.detect_pgch.outputs.has_tests == 'true'
        env:
          STORAGE_MODE: pgch
          PG_DSN: postgresql+asyncpg://pbi_user:pbi_pass@postgres:5432/pbi_db
          CH_URL: http://clickhouse:8123
          CH_USER: default
          CH_PASS: ""
        run: |
          pytest -q app/tests/test_api_pgch*.py -s --basetemp=tests_output || true

      - name: No PGCH tests – skipping
        if: steps.detect_pgch.outputs.has_tests != 'true'
        run: echo "No app/tests/test_api_pgch*.py – job skipped."
